<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.353">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Robert W Schlegel">
<meta name="dcterms.date" content="2024-05-18">

<title>heatwaveR training session</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="heatwaveR_workshop_2024_files/libs/clipboard/clipboard.min.js"></script>
<script src="heatwaveR_workshop_2024_files/libs/quarto-html/quarto.js"></script>
<script src="heatwaveR_workshop_2024_files/libs/quarto-html/popper.min.js"></script>
<script src="heatwaveR_workshop_2024_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="heatwaveR_workshop_2024_files/libs/quarto-html/anchor.min.js"></script>
<link href="heatwaveR_workshop_2024_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="heatwaveR_workshop_2024_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="heatwaveR_workshop_2024_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="heatwaveR_workshop_2024_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="heatwaveR_workshop_2024_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">


</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#overview" id="toc-overview" class="nav-link active" data-scroll-target="#overview">Overview</a></li>
  <li><a href="#mhw-detection" id="toc-mhw-detection" class="nav-link" data-scroll-target="#mhw-detection">MHW detection</a></li>
  <li><a href="#mhw-visualisation" id="toc-mhw-visualisation" class="nav-link" data-scroll-target="#mhw-visualisation">MHW visualisation</a>
  <ul class="collapse">
  <li><a href="#default-mhw-visuals" id="toc-default-mhw-visuals" class="nav-link" data-scroll-target="#default-mhw-visuals">Default MHW visuals</a></li>
  <li><a href="#custom-mhw-visuals" id="toc-custom-mhw-visuals" class="nav-link" data-scroll-target="#custom-mhw-visuals">Custom MHW visuals</a></li>
  <li><a href="#spicy-mhw-visuals" id="toc-spicy-mhw-visuals" class="nav-link" data-scroll-target="#spicy-mhw-visuals">Spicy MHW visuals</a></li>
  </ul></li>
  <li><a href="#mcs-detection" id="toc-mcs-detection" class="nav-link" data-scroll-target="#mcs-detection">MCS detection</a></li>
  <li><a href="#mcs-visualisation" id="toc-mcs-visualisation" class="nav-link" data-scroll-target="#mcs-visualisation">MCS visualisation</a>
  <ul class="collapse">
  <li><a href="#default-mcs-visuals" id="toc-default-mcs-visuals" class="nav-link" data-scroll-target="#default-mcs-visuals">Default MCS visuals</a></li>
  <li><a href="#custom-mcs-visuals" id="toc-custom-mcs-visuals" class="nav-link" data-scroll-target="#custom-mcs-visuals">Custom MCS visuals</a></li>
  <li><a href="#minty-mcs-visuals" id="toc-minty-mcs-visuals" class="nav-link" data-scroll-target="#minty-mcs-visuals">Minty MCS visuals</a></li>
  </ul></li>
  <li><a href="#mhw-categories" id="toc-mhw-categories" class="nav-link" data-scroll-target="#mhw-categories">MHW categories</a>
  <ul class="collapse">
  <li><a href="#default-mhw-category-visuals" id="toc-default-mhw-category-visuals" class="nav-link" data-scroll-target="#default-mhw-category-visuals">Default MHW category visuals</a></li>
  <li><a href="#custom-mhw-category-visuals" id="toc-custom-mhw-category-visuals" class="nav-link" data-scroll-target="#custom-mhw-category-visuals">Custom MHW category visuals</a></li>
  </ul></li>
  <li><a href="#mcs-categories" id="toc-mcs-categories" class="nav-link" data-scroll-target="#mcs-categories">MCS categories</a></li>
  <li><a href="#visualising-mcs-categories" id="toc-visualising-mcs-categories" class="nav-link" data-scroll-target="#visualising-mcs-categories">Visualising MCS categories</a>
  <ul class="collapse">
  <li><a href="#default-mcs-category-visuals" id="toc-default-mcs-category-visuals" class="nav-link" data-scroll-target="#default-mcs-category-visuals">Default MCS category visuals</a></li>
  <li><a href="#custom-mcs-category-visuals" id="toc-custom-mcs-category-visuals" class="nav-link" data-scroll-target="#custom-mcs-category-visuals">Custom MCS category visuals</a></li>
  </ul></li>
  <li><a href="#category-colour-palettes" id="toc-category-colour-palettes" class="nav-link" data-scroll-target="#category-colour-palettes">Category colour palettes</a></li>
  <li><a href="#subset-data-download" id="toc-subset-data-download" class="nav-link" data-scroll-target="#subset-data-download">Subset data download</a>
  <ul class="collapse">
  <li><a href="#file-information" id="toc-file-information" class="nav-link" data-scroll-target="#file-information">File information</a></li>
  <li><a href="#download-function" id="toc-download-function" class="nav-link" data-scroll-target="#download-function">Download function</a></li>
  <li><a href="#date-range" id="toc-date-range" class="nav-link" data-scroll-target="#date-range">Date range</a></li>
  <li><a href="#downloadprep-data" id="toc-downloadprep-data" class="nav-link" data-scroll-target="#downloadprep-data">Download/prep data</a></li>
  <li><a href="#visualise-data" id="toc-visualise-data" class="nav-link" data-scroll-target="#visualise-data">Visualise data</a></li>
  <li><a href="#save-data" id="toc-save-data" class="nav-link" data-scroll-target="#save-data">Save data</a></li>
  </ul></li>
  <li><a href="#global-data-download" id="toc-global-data-download" class="nav-link" data-scroll-target="#global-data-download">Global data download</a>
  <ul class="collapse">
  <li><a href="#file-information-1" id="toc-file-information-1" class="nav-link" data-scroll-target="#file-information-1">File information</a></li>
  <li><a href="#download-data" id="toc-download-data" class="nav-link" data-scroll-target="#download-data">Download data</a></li>
  <li><a href="#load-data" id="toc-load-data" class="nav-link" data-scroll-target="#load-data">Load data</a></li>
  <li><a href="#visualise-data-1" id="toc-visualise-data-1" class="nav-link" data-scroll-target="#visualise-data-1">Visualise data</a></li>
  </ul></li>
  <li><a href="#gridded-event-detection" id="toc-gridded-event-detection" class="nav-link" data-scroll-target="#gridded-event-detection">Gridded event detection</a>
  <ul class="collapse">
  <li><a href="#two-good-choices-dplyr-vs.-plyr" id="toc-two-good-choices-dplyr-vs.-plyr" class="nav-link" data-scroll-target="#two-good-choices-dplyr-vs.-plyr">Two good choices: <strong><code>dplyr</code></strong> vs.&nbsp;<strong><code>plyr</code></strong></a></li>
  </ul></li>
  <li><a href="#references" id="toc-references" class="nav-link" data-scroll-target="#references">References</a></li>
  </ul>
</nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><strong><code>heatwaveR</code></strong> training session</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Robert W Schlegel </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">May 18, 2024</p>
    </div>
  </div>
  
    
  </div>
  

</header>

<section id="overview" class="level2">
<h2 class="anchored" data-anchor-id="overview">Overview</h2>
<p>In this training session we will walk through a workflow for detecting marine heatwaves (MHWs) with the <strong><code>heatwaveR</code></strong> package that should be applicable to and useful for most use cases. One should note that we are assuming a basic knowledge of the Hobday et al.&nbsp;(2016, 2018) MHW definition. If a refresher is desirable, an interactive version is available <a href="http://choc.imev-mer.fr/shiny/demoMHW/">here</a>.</p>
<p>For this training session we will make use of the following packages:</p>
<div class="cell" data-layout-align="centre">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># First install the required packages</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="co"># NB: We don't want to load 'plyr', just install it</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>new_packages <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"tidyverse"</span>, <span class="st">"tidync"</span>, <span class="st">"heatwaveR"</span>, <span class="st">"rerddap"</span>, <span class="st">"doParallel"</span>, <span class="st">"plyr"</span>)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="fu">setdiff</span>(new_packages, <span class="fu">rownames</span>(<span class="fu">installed.packages</span>())))</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="co"># We start by loading the full suite of tidyverse packages</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse, <span class="at">quietly =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="co"># And a package for tidy NetCDF files</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidync)</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Then we load the main package used for detecting MHWs</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(heatwaveR)</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Another used to download data</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rerddap)</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="co"># And finally one that let's us work on multiple cores</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(doParallel)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="mhw-detection" class="level2">
<h2 class="anchored" data-anchor-id="mhw-detection">MHW detection</h2>
<p>The <code>detect_event()</code> function is the core of the <strong><code>heatwaveR</code></strong> package. It expects to be fed the output of the second core function, <code>ts2clm()</code>. By default, <code>ts2clm()</code> wants to receive a two-column dataframe with one column labelled <code>t</code> containing all of the date values, and a second column <code>temp</code> containing all of the temperature values. Please note that the date format it expects is “YYYY-MM-DD”, e.g.:</p>
<div class="cell" data-layout-align="centre">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(heatwaveR<span class="sc">::</span>sst_WA)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 2
  t           temp
  &lt;date&gt;     &lt;dbl&gt;
1 1982-01-01  20.9
2 1982-01-02  21.2
3 1982-01-03  21.4
4 1982-01-04  21.2
5 1982-01-05  21.3
6 1982-01-06  21.6</code></pre>
</div>
</div>
<p>Here are the <code>ts2clm()</code> and <code>detect_event()</code> function applied to the Western Australia test data:</p>
<div class="cell" data-layout-align="centre">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Detect the events in a time series</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>ts <span class="ot">&lt;-</span> <span class="fu">ts2clm</span>(sst_WA, <span class="at">climatologyPeriod =</span> <span class="fu">c</span>(<span class="st">"1982-01-01"</span>, <span class="st">"2011-12-31"</span>))</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>mhw <span class="ot">&lt;-</span> <span class="fu">detect_event</span>(ts)</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="co"># View just a few metrics</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>mhw<span class="sc">$</span>event <span class="sc">|&gt;</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">|&gt;</span> </span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(event_no, duration, date_start, date_peak, intensity_max, intensity_cumulative) <span class="sc">|&gt;</span>  </span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">arrange</span>(<span class="sc">-</span>intensity_max) <span class="sc">|&gt;</span> </span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>(<span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 6
  event_no duration date_start date_peak  intensity_max intensity_cumulative
     &lt;int&gt;    &lt;dbl&gt; &lt;date&gt;     &lt;date&gt;             &lt;dbl&gt;                &lt;dbl&gt;
1       52      105 2010-12-24 2011-02-28          6.58                293. 
2       41       35 2008-03-25 2008-04-14          3.83                 79.3
3       29       95 1999-05-13 1999-05-22          3.64                240. 
4       60       14 2012-12-27 2012-12-31          3.42                 32.3
5       59      101 2012-01-10 2012-01-27          3.38                214. </code></pre>
</div>
</div>
<blockquote class="blockquote">
<blockquote class="blockquote">
<p>How might these results change with a different <code>climatologyPeriod</code>?</p>
</blockquote>
</blockquote>
</section>
<section id="mhw-visualisation" class="level2">
<h2 class="anchored" data-anchor-id="mhw-visualisation">MHW visualisation</h2>
<section id="default-mhw-visuals" class="level3">
<h3 class="anchored" data-anchor-id="default-mhw-visuals">Default MHW visuals</h3>
<p>One may use <code>event_line()</code> and <code>lolli_plot()</code> directly on the output of <code>detect_event()</code>. For example, the massive Western Australia heatwave of 2011:</p>
<div class="cell" data-layout-align="centre">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">event_line</span>(mhw, <span class="at">spread =</span> <span class="dv">180</span>, <span class="at">metric =</span> <span class="st">"intensity_max"</span>, </span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>           <span class="at">start_date =</span> <span class="st">"1982-01-01"</span>, <span class="at">end_date =</span> <span class="st">"2014-12-31"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-example1" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="heatwaveR_workshop_2024_files/figure-html/fig-example1-1.png" class="img-fluid figure-img" width="960"></p>
<figcaption class="figure-caption">Figure&nbsp;1: Default flame plot.</figcaption>
</figure>
</div>
</div>
</div>
<div class="cell" data-layout-align="centre">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">lolli_plot</span>(mhw, <span class="at">metric =</span> <span class="st">"intensity_max"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-example2" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="heatwaveR_workshop_2024_files/figure-html/fig-example2-1.png" class="img-fluid figure-img" width="960"></p>
<figcaption class="figure-caption">Figure&nbsp;2: Default lolli-plot</figcaption>
</figure>
</div>
</div>
</div>
<blockquote class="blockquote">
<blockquote class="blockquote">
<p>What are some other ways to use <code>lolli_plot()</code>?</p>
</blockquote>
</blockquote>
</section>
<section id="custom-mhw-visuals" class="level3">
<h3 class="anchored" data-anchor-id="custom-mhw-visuals">Custom MHW visuals</h3>
<p>There are custom <code>geoms</code> in the <strong><code>heatwaveR</code></strong> package that help us to visualise MHWs. To use these we must first access the <code>climatology</code> or <code>event</code> dataframes produced by <code>detect_event()</code>. Here is how:</p>
<div class="cell" data-layout-align="centre">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Select the region of the time series of interest</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>mhw2 <span class="ot">&lt;-</span> mhw<span class="sc">$</span>climatology <span class="sc">|&gt;</span> </span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="dv">10580</span><span class="sc">:</span><span class="dv">10720</span>)</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(mhw2, <span class="fu">aes</span>(<span class="at">x =</span> t, <span class="at">y =</span> temp, <span class="at">y2 =</span> thresh)) <span class="sc">+</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>  heatwaveR<span class="sc">::</span><span class="fu">geom_flame</span>() <span class="sc">+</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">as.Date</span>(<span class="st">"2011-02-25"</span>), <span class="at">y =</span> <span class="fl">25.8</span>, <span class="at">label =</span> <span class="st">"the Destroyer</span><span class="sc">\n</span><span class="st">of Kelps"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-example3" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="heatwaveR_workshop_2024_files/figure-html/fig-example3-1.png" class="img-fluid figure-img" width="960"></p>
<figcaption class="figure-caption">Figure&nbsp;3: Custom flame plot</figcaption>
</figure>
</div>
</div>
</div>
<div class="cell" data-layout-align="centre">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(mhw<span class="sc">$</span>event, <span class="fu">aes</span>(<span class="at">x =</span> date_start, <span class="at">y =</span> intensity_max)) <span class="sc">+</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>  heatwaveR<span class="sc">::</span><span class="fu">geom_lolli</span>(<span class="at">colour =</span> <span class="st">"salmon"</span>, <span class="at">colour_n =</span> <span class="st">"red"</span>, <span class="at">n =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotate</span>(<span class="at">geom =</span> <span class="st">"text"</span>, <span class="at">colour =</span> <span class="st">"black"</span>, <span class="at">x =</span> <span class="fu">as.Date</span>(<span class="st">"2004-04-01"</span>), <span class="at">y =</span> <span class="dv">5</span>,</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>           <span class="at">label =</span> <span class="st">"The marine heatwaves</span><span class="sc">\n</span><span class="st">Tend to be left skewed in a</span><span class="sc">\n</span><span class="st">Given time series"</span>) <span class="sc">+</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">y =</span> <span class="st">"Max. intensity [°C]"</span>, <span class="at">x =</span> <span class="cn">NULL</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-example4" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="heatwaveR_workshop_2024_files/figure-html/fig-example4-1.png" class="img-fluid figure-img" width="960"></p>
<figcaption class="figure-caption">Figure&nbsp;4: Custom lolli-plot</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="spicy-mhw-visuals" class="level3">
<h3 class="anchored" data-anchor-id="spicy-mhw-visuals">Spicy MHW visuals</h3>
<p>The default output of these function may not be to your liking. If so, not to worry, the code is very malleable. If we wanted to reproduce the format of the MHWs as seen in Hobday et al.&nbsp;(2016), for example, the code would look something like this:</p>
<div class="cell" data-layout-align="centre">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># It is necessary to give geom_flame() at least one row on either side of </span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="co"># the event in order to calculate the polygon corners smoothly</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>mhw_top <span class="ot">&lt;-</span> mhw2 <span class="sc">|&gt;</span> </span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="dv">5</span><span class="sc">:</span><span class="dv">111</span>)</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> mhw2, <span class="fu">aes</span>(<span class="at">x =</span> t)) <span class="sc">+</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_flame</span>(<span class="fu">aes</span>(<span class="at">y =</span> temp, <span class="at">y2 =</span> thresh, <span class="at">fill =</span> <span class="st">"all"</span>), <span class="at">show.legend =</span> T) <span class="sc">+</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_flame</span>(<span class="at">data =</span> mhw_top, <span class="fu">aes</span>(<span class="at">y =</span> temp, <span class="at">y2 =</span> thresh, <span class="at">fill =</span> <span class="st">"top"</span>),  <span class="at">show.legend =</span> T) <span class="sc">+</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> temp, <span class="at">colour =</span> <span class="st">"temp"</span>)) <span class="sc">+</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> thresh, <span class="at">colour =</span> <span class="st">"thresh"</span>), <span class="at">linewidth =</span> <span class="fl">1.0</span>) <span class="sc">+</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> seas, <span class="at">colour =</span> <span class="st">"seas"</span>), <span class="at">linewidth =</span> <span class="fl">1.2</span>) <span class="sc">+</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_colour_manual</span>(<span class="at">name =</span> <span class="st">"Line Colour"</span>,</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>                      <span class="at">values =</span> <span class="fu">c</span>(<span class="st">"temp"</span> <span class="ot">=</span> <span class="st">"black"</span>, </span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>                                 <span class="st">"thresh"</span> <span class="ot">=</span>  <span class="st">"forestgreen"</span>, </span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>                                 <span class="st">"seas"</span> <span class="ot">=</span> <span class="st">"grey80"</span>)) <span class="sc">+</span></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">name =</span> <span class="st">"Event Colour"</span>, </span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>                    <span class="at">values =</span> <span class="fu">c</span>(<span class="st">"all"</span> <span class="ot">=</span> <span class="st">"salmon"</span>, </span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>                               <span class="st">"top"</span> <span class="ot">=</span> <span class="st">"red"</span>)) <span class="sc">+</span></span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_date</span>(<span class="at">date_labels =</span> <span class="st">"%b %Y"</span>) <span class="sc">+</span></span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">colour =</span> <span class="fu">guide_legend</span>(<span class="at">override.aes =</span> <span class="fu">list</span>(<span class="at">fill =</span> <span class="cn">NA</span>))) <span class="sc">+</span></span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">y =</span> <span class="fu">expression</span>(<span class="fu">paste</span>(<span class="st">"Temperature ["</span>, degree, <span class="st">"C]"</span>)), <span class="at">x =</span> <span class="cn">NULL</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-example5" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="heatwaveR_workshop_2024_files/figure-html/fig-example5-1.png" class="img-fluid figure-img" width="960"></p>
<figcaption class="figure-caption">Figure&nbsp;5: Spicy MHW visual.</figcaption>
</figure>
</div>
</div>
</div>
<p>It is also worth pointing out that when we use <code>geom_flame()</code> directly like this, but we don’t want to highlight events greater less than our standard five day length, allowing for a two day gap, we want to use the arguments <code>n</code> and <code>n_gap</code> respectively.</p>
<div class="cell" data-layout-align="centre">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>mhw3 <span class="ot">&lt;-</span> mhw<span class="sc">$</span>climatology <span class="sc">|&gt;</span> </span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="dv">850</span><span class="sc">:</span><span class="dv">950</span>)</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(mhw3, <span class="fu">aes</span>(<span class="at">x =</span> t, <span class="at">y =</span> temp, <span class="at">y2 =</span> thresh)) <span class="sc">+</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_flame</span>(<span class="at">fill =</span> <span class="st">"black"</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Note the use of n = 5 and n_gap = 2 below</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_flame</span>(<span class="at">n =</span> <span class="dv">5</span>, <span class="at">n_gap =</span> <span class="dv">2</span>, <span class="at">fill =</span> <span class="st">"red"</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylim</span>(<span class="fu">c</span>(<span class="dv">22</span>, <span class="dv">25</span>)) <span class="sc">+</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_text</span>(<span class="at">colour =</span> <span class="st">"black"</span>, <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">as.Date</span>(<span class="st">"1984-05-16"</span>), <span class="at">y =</span> <span class="fl">24.5</span>,</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>                <span class="at">label =</span> <span class="st">"heat</span><span class="sc">\n\n\n\n\n</span><span class="st">spike"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-example6" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="heatwaveR_workshop_2024_files/figure-html/fig-example6-1.png" class="img-fluid figure-img" width="960"></p>
<figcaption class="figure-caption">Figure&nbsp;6: Bonus MHW visual.</figcaption>
</figure>
</div>
</div>
</div>
<p>Should we not wish to highlight any events with <code>geom_lolli()</code>, plot them with a colour other than the default, and use a different theme, it would look like this:</p>
<div class="cell" data-layout-align="centre">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(mhw<span class="sc">$</span>event, <span class="fu">aes</span>(<span class="at">x =</span> date_peak, <span class="at">y =</span> intensity_max)) <span class="sc">+</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_lolli</span>(<span class="at">colour =</span> <span class="st">"firebrick"</span>) <span class="sc">+</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Peak Date"</span>, </span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="fu">expression</span>(<span class="fu">paste</span>(<span class="st">"Max. intensity ["</span>, degree, <span class="st">"C]"</span>)), <span class="at">x =</span> <span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_linedraw</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-example7" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="heatwaveR_workshop_2024_files/figure-html/fig-example7-1.png" class="img-fluid figure-img" width="960"></p>
<figcaption class="figure-caption">Figure&nbsp;7: Bonus MHW lolli-plot.</figcaption>
</figure>
</div>
</div>
</div>
<blockquote class="blockquote">
<blockquote class="blockquote">
<p>What other ways can you think of to change the appearance of the MHW results?</p>
</blockquote>
</blockquote>
</section>
</section>
<section id="mcs-detection" class="level2">
<h2 class="anchored" data-anchor-id="mcs-detection">MCS detection</h2>
<p>The detection and visualisation of marine cold-spells (MCSs) is also possible. The main difference from detecting MHWs is that one uses the 10th percentile threshold, rather than the 90th. Here are the top five cold-spells (cumulative intensity) detected in the OISST data for Western Australia:</p>
<div class="cell" data-layout-align="centre">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># First calculate the cold-spells</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="co"># NB: Note the `coldSpells = TRUE` argument</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>ts_10th <span class="ot">&lt;-</span> <span class="fu">ts2clm</span>(sst_WA, <span class="at">climatologyPeriod =</span> <span class="fu">c</span>(<span class="st">"1982-01-01"</span>, <span class="st">"2011-12-31"</span>), <span class="at">pctile =</span> <span class="dv">10</span>)</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>mcs <span class="ot">&lt;-</span> <span class="fu">detect_event</span>(ts_10th, <span class="at">coldSpells =</span> <span class="cn">TRUE</span>)</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Then look at the top few events</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>mcs<span class="sc">$</span>event <span class="sc">|&gt;</span> </span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">|&gt;</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(event_no, duration, date_start,</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>                date_peak, intensity_mean, intensity_max, intensity_cumulative) <span class="sc">|&gt;</span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">arrange</span>(intensity_cumulative) <span class="sc">|&gt;</span> </span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>(<span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 7
  event_no duration date_start date_peak  intensity_mean intensity_max
     &lt;int&gt;    &lt;dbl&gt; &lt;date&gt;     &lt;date&gt;              &lt;dbl&gt;         &lt;dbl&gt;
1       15       76 1990-04-13 1990-05-11          -2.50         -3.19
2       49       58 2003-12-19 2004-01-23          -1.73         -2.59
3       83       41 2020-04-26 2020-05-25          -2.34         -3.14
4       64       52 2014-04-14 2014-05-05          -1.78         -2.54
5       77       46 2018-07-24 2018-08-02          -1.81         -2.43
# ℹ 1 more variable: intensity_cumulative &lt;dbl&gt;</code></pre>
</div>
</div>
<blockquote class="blockquote">
<blockquote class="blockquote">
<p>What is the first difference you notice between the output of MHW vs MCS detection?</p>
</blockquote>
</blockquote>
</section>
<section id="mcs-visualisation" class="level2">
<h2 class="anchored" data-anchor-id="mcs-visualisation">MCS visualisation</h2>
<section id="default-mcs-visuals" class="level3">
<h3 class="anchored" data-anchor-id="default-mcs-visuals">Default MCS visuals</h3>
<p>The default MCS plots:</p>
<div class="cell" data-layout-align="centre">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">event_line</span>(mcs, <span class="at">spread =</span> <span class="dv">200</span>, <span class="at">metric =</span> <span class="st">"intensity_cumulative"</span>,</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>           <span class="at">start_date =</span> <span class="st">"1982-01-01"</span>, <span class="at">end_date =</span> <span class="st">"2014-12-31"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-example8" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="heatwaveR_workshop_2024_files/figure-html/fig-example8-1.png" class="img-fluid figure-img" width="960"></p>
<figcaption class="figure-caption">Figure&nbsp;8: Example MCS visual.</figcaption>
</figure>
</div>
</div>
</div>
<div class="cell" data-layout-align="centre">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">lolli_plot</span>(mcs, <span class="at">metric =</span> <span class="st">"intensity_cumulative"</span>, <span class="at">xaxis =</span> <span class="st">"event_no"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-example9" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="heatwaveR_workshop_2024_files/figure-html/fig-example9-1.png" class="img-fluid figure-img" width="960"></p>
<figcaption class="figure-caption">Figure&nbsp;9: Example MCS lolli-plot</figcaption>
</figure>
</div>
</div>
</div>
<p>Note that one does not need to specify that MCSs are to be visualised, the functions are able to understand this on their own.</p>
</section>
<section id="custom-mcs-visuals" class="level3">
<h3 class="anchored" data-anchor-id="custom-mcs-visuals">Custom MCS visuals</h3>
<p>Cold spell figures may be created as <code>geoms</code> in <strong><code>ggplot2</code></strong>, too:</p>
<div class="cell" data-layout-align="centre">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Select the region of the time series of interest</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>mcs2 <span class="ot">&lt;-</span> mcs<span class="sc">$</span>climatology <span class="sc">|&gt;</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="dv">2900</span><span class="sc">:</span><span class="dv">3190</span>)</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Note that one must specify a colour other than the default 'salmon'</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(mcs2, <span class="fu">aes</span>(<span class="at">x =</span> t, <span class="at">y =</span> thresh, <span class="at">y2 =</span> temp)) <span class="sc">+</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_flame</span>(<span class="at">fill =</span> <span class="st">"steelblue3"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-example10" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="heatwaveR_workshop_2024_files/figure-html/fig-example10-1.png" class="img-fluid figure-img" width="960"></p>
<figcaption class="figure-caption">Figure&nbsp;10: Custom MCS visual.</figcaption>
</figure>
</div>
</div>
</div>
<div class="cell" data-layout-align="centre">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(mcs<span class="sc">$</span>event, <span class="fu">aes</span>(<span class="at">x =</span> date_start, <span class="at">y =</span> intensity_max)) <span class="sc">+</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_lolli</span>(<span class="at">colour =</span> <span class="st">"steelblue3"</span>, <span class="at">colour_n =</span> <span class="st">"navy"</span>, <span class="at">n =</span> <span class="dv">10</span>) <span class="sc">+</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Start Date"</span>,</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"Max. intensity [°C]"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-example11" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="heatwaveR_workshop_2024_files/figure-html/fig-example11-1.png" class="img-fluid figure-img" width="960"></p>
<figcaption class="figure-caption">Figure&nbsp;11: Custom MCS lolli=plot</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="minty-mcs-visuals" class="level3">
<h3 class="anchored" data-anchor-id="minty-mcs-visuals">Minty MCS visuals</h3>
<p>Again, because <code>geom_flame()</code> and <code>geom_lolli()</code> are simple <strong><code>ggplot2</code></strong> <code>geoms</code>, one can go completely bananas with them:</p>
<div class="cell" data-layout-align="centre">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>mcs_top <span class="ot">&lt;-</span> mcs2 <span class="sc">|&gt;</span> </span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="dv">125</span><span class="sc">:</span><span class="dv">202</span>)</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> mcs2, <span class="fu">aes</span>(<span class="at">x =</span> t)) <span class="sc">+</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_flame</span>(<span class="fu">aes</span>(<span class="at">y =</span> thresh, <span class="at">y2 =</span> temp, <span class="at">fill =</span> <span class="st">"all"</span>), <span class="at">show.legend =</span> T) <span class="sc">+</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_flame</span>(<span class="at">data =</span> mcs_top, <span class="fu">aes</span>(<span class="at">y =</span> thresh, <span class="at">y2 =</span> temp, <span class="at">fill =</span> <span class="st">"top"</span>), <span class="at">show.legend =</span> T) <span class="sc">+</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> temp, <span class="at">colour =</span> <span class="st">"temp"</span>)) <span class="sc">+</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> thresh, <span class="at">colour =</span> <span class="st">"thresh"</span>), <span class="at">linewidth =</span> <span class="fl">1.0</span>) <span class="sc">+</span></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> seas, <span class="at">colour =</span> <span class="st">"seas"</span>), <span class="at">linewidth =</span> <span class="fl">1.2</span>) <span class="sc">+</span></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_colour_manual</span>(<span class="at">name =</span> <span class="st">"Line Colour"</span>,</span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>                      <span class="at">values =</span> <span class="fu">c</span>(<span class="st">"temp"</span> <span class="ot">=</span> <span class="st">"black"</span>, <span class="st">"thresh"</span> <span class="ot">=</span>  <span class="st">"forestgreen"</span>, <span class="st">"seas"</span> <span class="ot">=</span> <span class="st">"grey80"</span>)) <span class="sc">+</span></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">name =</span> <span class="st">"Event Colour"</span>, <span class="at">values =</span> <span class="fu">c</span>(<span class="st">"all"</span> <span class="ot">=</span> <span class="st">"steelblue3"</span>, <span class="st">"top"</span> <span class="ot">=</span> <span class="st">"navy"</span>)) <span class="sc">+</span></span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_date</span>(<span class="at">date_labels =</span> <span class="st">"%b %Y"</span>) <span class="sc">+</span></span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">colour =</span> <span class="fu">guide_legend</span>(<span class="at">override.aes =</span> <span class="fu">list</span>(<span class="at">fill =</span> <span class="cn">NA</span>))) <span class="sc">+</span></span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">y =</span> <span class="fu">expression</span>(<span class="fu">paste</span>(<span class="st">"Temperature ["</span>, degree, <span class="st">"C]"</span>)), <span class="at">x =</span> <span class="cn">NULL</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-example12" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="heatwaveR_workshop_2024_files/figure-html/fig-example12-1.png" class="img-fluid figure-img" width="960"></p>
<figcaption class="figure-caption">Figure&nbsp;12: Minty MCS visual.</figcaption>
</figure>
</div>
</div>
</div>
<div class="cell" data-layout-align="centre">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(mcs<span class="sc">$</span>event, <span class="fu">aes</span>(<span class="at">x =</span> date_start, <span class="at">y =</span> intensity_cumulative)) <span class="sc">+</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_lolli</span>(<span class="at">colour =</span> <span class="st">"steelblue3"</span>, <span class="at">colour_n =</span> <span class="st">"navy"</span>, <span class="at">n =</span> <span class="dv">7</span>) <span class="sc">+</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>( <span class="at">x =</span> <span class="st">"Start Date"</span>, <span class="at">y =</span> <span class="st">"Cumulative intensity [days x °C]"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-example13" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="heatwaveR_workshop_2024_files/figure-html/fig-example13-1.png" class="img-fluid figure-img" width="960"></p>
<figcaption class="figure-caption">Figure&nbsp;13: Minty MCS lolli-plot.</figcaption>
</figure>
</div>
</div>
</div>
<blockquote class="blockquote">
<blockquote class="blockquote">
<p>How would you plot MCSs differently to these examples?</p>
</blockquote>
</blockquote>
</section>
</section>
<section id="mhw-categories" class="level2">
<h2 class="anchored" data-anchor-id="mhw-categories">MHW categories</h2>
<p>The categories of MHWs under the Hobday et al.&nbsp;(2018) naming scheme may be calculated with the <strong><code>heatwaveR</code></strong> package using the <code>category()</code> function on the output of the <code>detect_event()</code> function. Because we have calculated MHWs on the Western Australia data, we provide the name “WA” below:</p>
<div class="cell" data-layout-align="centre">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Detect events</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>ts <span class="ot">&lt;-</span> <span class="fu">ts2clm</span>(sst_WA, <span class="at">climatologyPeriod =</span> <span class="fu">c</span>(<span class="st">"1982-01-01"</span>, <span class="st">"2011-12-31"</span>))</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>MHW <span class="ot">&lt;-</span> <span class="fu">detect_event</span>(ts) </span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>MHW_cat <span class="ot">&lt;-</span> <span class="fu">category</span>(MHW, <span class="at">S =</span> <span class="cn">TRUE</span>, <span class="at">name =</span> <span class="st">"WA"</span>)</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Look at the top few events</span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a><span class="fu">tail</span>(MHW_cat)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 11
  event_no event_name peak_date  category   i_max duration p_moderate p_strong
     &lt;int&gt; &lt;fct&gt;      &lt;date&gt;     &lt;chr&gt;      &lt;dbl&gt;    &lt;dbl&gt;      &lt;dbl&gt;    &lt;dbl&gt;
1       60 WA 2012b   2012-12-31 II Strong   3.42       14         64       36
2       29 WA 1999    1999-05-22 II Strong   3.64       95         63       37
3       47 WA 2009    2009-03-25 II Strong   2.38        7         57       43
4       72 WA 2015    2015-10-02 II Strong   2.46        7         57       43
5       41 WA 2008a   2008-04-14 III Severe  3.83       35         57       23
6       52 WA 2011a   2011-02-28 IV Extreme  6.58      105         52       27
# ℹ 3 more variables: p_severe &lt;dbl&gt;, p_extreme &lt;dbl&gt;, season &lt;chr&gt;</code></pre>
</div>
</div>
<p>Note that this functions expects the data to have been collected in the southern hemisphere, hence the argument <code>S = TRUE</code>. If they were not, one must set <code>S = FALSE</code> as seen in the example below. This ensures that the correct seasons are attributed to the event.</p>
<div class="cell" data-layout-align="centre">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>res_Med <span class="ot">&lt;-</span> <span class="fu">detect_event</span>(<span class="fu">ts2clm</span>(sst_Med, <span class="at">climatologyPeriod =</span> <span class="fu">c</span>(<span class="st">"1982-01-01"</span>, <span class="st">"2011-12-31"</span>)))</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>res_Med_cat <span class="ot">&lt;-</span> <span class="fu">category</span>(res_Med, <span class="at">S =</span> <span class="cn">FALSE</span>, <span class="at">name =</span> <span class="st">"Med"</span>)</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="fu">tail</span>(res_Med_cat)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 11
  event_no event_name peak_date  category   i_max duration p_moderate p_strong
     &lt;int&gt; &lt;fct&gt;      &lt;date&gt;     &lt;chr&gt;      &lt;dbl&gt;    &lt;dbl&gt;      &lt;dbl&gt;    &lt;dbl&gt;
1       30 Med 2003a  2003-06-20 II Strong   5.05       30         53       47
2       98 Med 2018b  2018-08-04 II Strong   4.75       44         52       48
3       67 Med 2012b  2012-08-20 II Strong   4.32       18         44       56
4       46 Med 2007c  2007-04-25 III Severe  4.05       19         42       53
5       75 Med 2014   2014-10-18 II Strong   3.34      144         39       60
6       96 Med 2018a  2018-04-28 II Strong   3.32       11         27       73
# ℹ 3 more variables: p_severe &lt;dbl&gt;, p_extreme &lt;dbl&gt;, season &lt;chr&gt;</code></pre>
</div>
</div>
<section id="default-mhw-category-visuals" class="level3">
<h3 class="anchored" data-anchor-id="default-mhw-category-visuals">Default MHW category visuals</h3>
<p>A quick and easy visualisation of the categories of a MHW may be accomplished with <code>event_line()</code> by setting the <code>category</code> argument to <code>TRUE</code>.</p>
<div class="cell" data-layout-align="centre">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="fu">event_line</span>(MHW, <span class="at">spread =</span> <span class="dv">100</span>, <span class="at">start_date =</span> <span class="st">"2010-11-01"</span>, <span class="at">end_date =</span> <span class="st">"2011-06-30"</span>, <span class="at">category =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-example-1" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="heatwaveR_workshop_2024_files/figure-html/fig-example-1-1.png" class="img-fluid figure-img" width="960"></p>
<figcaption class="figure-caption">Figure&nbsp;14: Default MHW category visual.</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="custom-mhw-category-visuals" class="level3">
<h3 class="anchored" data-anchor-id="custom-mhw-category-visuals">Custom MHW category visuals</h3>
<p>Were one to want to visualise the categories of a MHW ‘by hand’, the following code will provide a good starting point.</p>
<div class="cell" data-layout-align="centre">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create category breaks and select slice of data.frame</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>clim_cat <span class="ot">&lt;-</span> MHW<span class="sc">$</span>clim <span class="sc">|&gt;</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">diff =</span> thresh <span class="sc">-</span> seas,</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>                <span class="at">thresh_2x =</span> thresh <span class="sc">+</span> diff,</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>                <span class="at">thresh_3x =</span> thresh_2x <span class="sc">+</span> diff,</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>                <span class="at">thresh_4x =</span> thresh_3x <span class="sc">+</span> diff) <span class="sc">|&gt;</span> </span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">slice</span>(<span class="dv">10580</span><span class="sc">:</span><span class="dv">10690</span>)</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Set line colours</span></span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>lineColCat <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Temperature"</span> <span class="ot">=</span> <span class="st">"black"</span>,</span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Climatology"</span> <span class="ot">=</span> <span class="st">"gray20"</span>,</span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Threshold"</span> <span class="ot">=</span> <span class="st">"darkgreen"</span>,</span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a>  <span class="st">"2x Threshold"</span> <span class="ot">=</span> <span class="st">"darkgreen"</span>,</span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a>  <span class="st">"3x Threshold"</span> <span class="ot">=</span> <span class="st">"darkgreen"</span>,</span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a>  <span class="st">"4x Threshold"</span> <span class="ot">=</span> <span class="st">"darkgreen"</span></span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Set category fill colours</span></span>
<span id="cb26-20"><a href="#cb26-20" aria-hidden="true" tabindex="-1"></a>fillColCat <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb26-21"><a href="#cb26-21" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Moderate"</span> <span class="ot">=</span> <span class="st">"#ffc866"</span>,</span>
<span id="cb26-22"><a href="#cb26-22" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Strong"</span> <span class="ot">=</span> <span class="st">"#ff6900"</span>,</span>
<span id="cb26-23"><a href="#cb26-23" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Severe"</span> <span class="ot">=</span> <span class="st">"#9e0000"</span>,</span>
<span id="cb26-24"><a href="#cb26-24" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Extreme"</span> <span class="ot">=</span> <span class="st">"#2d0000"</span></span>
<span id="cb26-25"><a href="#cb26-25" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb26-26"><a href="#cb26-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-27"><a href="#cb26-27" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> clim_cat, <span class="fu">aes</span>(<span class="at">x =</span> t, <span class="at">y =</span> temp)) <span class="sc">+</span></span>
<span id="cb26-28"><a href="#cb26-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_flame</span>(<span class="fu">aes</span>(<span class="at">y2 =</span> thresh, <span class="at">fill =</span> <span class="st">"Moderate"</span>)) <span class="sc">+</span></span>
<span id="cb26-29"><a href="#cb26-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_flame</span>(<span class="fu">aes</span>(<span class="at">y2 =</span> thresh_2x, <span class="at">fill =</span> <span class="st">"Strong"</span>)) <span class="sc">+</span></span>
<span id="cb26-30"><a href="#cb26-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_flame</span>(<span class="fu">aes</span>(<span class="at">y2 =</span> thresh_3x, <span class="at">fill =</span> <span class="st">"Severe"</span>)) <span class="sc">+</span></span>
<span id="cb26-31"><a href="#cb26-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_flame</span>(<span class="fu">aes</span>(<span class="at">y2 =</span> thresh_4x, <span class="at">fill =</span> <span class="st">"Extreme"</span>)) <span class="sc">+</span></span>
<span id="cb26-32"><a href="#cb26-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> thresh_2x, <span class="at">col =</span> <span class="st">"2x Threshold"</span>), <span class="at">size =</span> <span class="fl">0.7</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb26-33"><a href="#cb26-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> thresh_3x, <span class="at">col =</span> <span class="st">"3x Threshold"</span>), <span class="at">size =</span> <span class="fl">0.7</span>, <span class="at">linetype =</span> <span class="st">"dotdash"</span>) <span class="sc">+</span></span>
<span id="cb26-34"><a href="#cb26-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> thresh_4x, <span class="at">col =</span> <span class="st">"4x Threshold"</span>), <span class="at">size =</span> <span class="fl">0.7</span>, <span class="at">linetype =</span> <span class="st">"dotted"</span>) <span class="sc">+</span></span>
<span id="cb26-35"><a href="#cb26-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> seas, <span class="at">col =</span> <span class="st">"Climatology"</span>), <span class="at">size =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb26-36"><a href="#cb26-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> thresh, <span class="at">col =</span> <span class="st">"Threshold"</span>), <span class="at">size =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb26-37"><a href="#cb26-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> temp, <span class="at">col =</span> <span class="st">"Temperature"</span>), <span class="at">size =</span> <span class="fl">0.6</span>) <span class="sc">+</span></span>
<span id="cb26-38"><a href="#cb26-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_colour_manual</span>(<span class="at">name =</span> <span class="cn">NULL</span>, <span class="at">values =</span> lineColCat,</span>
<span id="cb26-39"><a href="#cb26-39" aria-hidden="true" tabindex="-1"></a>                      <span class="at">breaks =</span> <span class="fu">c</span>(<span class="st">"Temperature"</span>, <span class="st">"Climatology"</span>, <span class="st">"Threshold"</span>,</span>
<span id="cb26-40"><a href="#cb26-40" aria-hidden="true" tabindex="-1"></a>                                 <span class="st">"2x Threshold"</span>, <span class="st">"3x Threshold"</span>, <span class="st">"4x Threshold"</span>)) <span class="sc">+</span></span>
<span id="cb26-41"><a href="#cb26-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">name =</span> <span class="cn">NULL</span>, <span class="at">values =</span> fillColCat, <span class="at">guide =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb26-42"><a href="#cb26-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_date</span>(<span class="at">date_labels =</span> <span class="st">"%b %Y"</span>) <span class="sc">+</span></span>
<span id="cb26-43"><a href="#cb26-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">colour =</span> <span class="fu">guide_legend</span>(<span class="at">override.aes =</span> <span class="fu">list</span>(<span class="at">linetype =</span> <span class="fu">c</span>(<span class="st">"solid"</span>, <span class="st">"solid"</span>, <span class="st">"solid"</span>,</span>
<span id="cb26-44"><a href="#cb26-44" aria-hidden="true" tabindex="-1"></a>                                                                <span class="st">"dashed"</span>, <span class="st">"dotdash"</span>, <span class="st">"dotted"</span>),</span>
<span id="cb26-45"><a href="#cb26-45" aria-hidden="true" tabindex="-1"></a>                                                   <span class="at">size =</span> <span class="fu">c</span>(<span class="fl">0.6</span>, <span class="fl">0.7</span>, <span class="fl">0.7</span>, <span class="fl">0.7</span>, <span class="fl">0.7</span>, <span class="fl">0.7</span>)))) <span class="sc">+</span></span>
<span id="cb26-46"><a href="#cb26-46" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">y =</span> <span class="st">"Temperature [°C]"</span>, <span class="at">x =</span> <span class="cn">NULL</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-example-2" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="heatwaveR_workshop_2024_files/figure-html/fig-example-2-1.png" class="img-fluid figure-img" width="960"></p>
<figcaption class="figure-caption">Figure&nbsp;15: Custom MHW category visual.</figcaption>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="mcs-categories" class="level2">
<h2 class="anchored" data-anchor-id="mcs-categories">MCS categories</h2>
<p>MCSs are calculated the same as for MHWs. The <code>category()</code> function will automagically detect if it has been fed MHWs or MCSs so no additional arguments are required. For the sake of clarity the following code chunks demonstrates how to calculate MCS categories.</p>
<div class="cell" data-layout-align="centre">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate events</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>ts_MCS <span class="ot">&lt;-</span> <span class="fu">ts2clm</span>(sst_WA, <span class="at">climatologyPeriod =</span> <span class="fu">c</span>(<span class="st">"1982-01-01"</span>, <span class="st">"2011-12-31"</span>), <span class="at">pctile =</span> <span class="dv">10</span>)</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>MCS <span class="ot">&lt;-</span> <span class="fu">detect_event</span>(ts_MCS, <span class="at">coldSpells =</span> T)</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>MCS_cat <span class="ot">&lt;-</span> <span class="fu">category</span>(MCS, <span class="at">S =</span> <span class="cn">TRUE</span>, <span class="at">name =</span> <span class="st">"WA"</span>)</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Look at the top few events</span></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a><span class="fu">tail</span>(MCS_cat)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 11
  event_no event_name peak_date  category  i_max duration p_moderate p_strong
     &lt;int&gt; &lt;fct&gt;      &lt;date&gt;     &lt;chr&gt;     &lt;dbl&gt;    &lt;dbl&gt;      &lt;dbl&gt;    &lt;dbl&gt;
1       77 WA 2018a   2018-08-02 II Strong -2.43       46         67       33
2       40 WA 2000    2000-08-13 II Strong -2.27       11         64       36
3       15 WA 1990    1990-05-11 II Strong -3.19       76         62       38
4       53 WA 2005    2005-10-16 II Strong -1.86       13         62       38
5       83 WA 2020    2020-05-25 II Strong -3.14       41         61       39
6       11 WA 1987    1987-12-10 II Strong -2.50        9         44       56
# ℹ 3 more variables: p_severe &lt;dbl&gt;, p_extreme &lt;dbl&gt;, season &lt;chr&gt;</code></pre>
</div>
</div>
</section>
<section id="visualising-mcs-categories" class="level2">
<h2 class="anchored" data-anchor-id="visualising-mcs-categories">Visualising MCS categories</h2>
<section id="default-mcs-category-visuals" class="level3">
<h3 class="anchored" data-anchor-id="default-mcs-category-visuals">Default MCS category visuals</h3>
<p>The <code>event_line()</code> function also works for visualising MCS categories. The function will automagically detect that it is being fed MCSs so we do not need to provide it with any new arguments. Note that the colour palette for MCS does have four colours, same as for MHWs, but none of the demo time series that come packaged with <strong><code>heatwaveR</code></strong> have MCSs that intense so we are not able to demonstrate the full colour palette here.</p>
<div class="cell" data-layout-align="centre">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="fu">event_line</span>(MCS, <span class="at">spread =</span> <span class="dv">100</span>, <span class="at">start_date =</span> <span class="st">"1989-11-01"</span>, <span class="at">end_date =</span> <span class="st">"1990-06-30"</span>, <span class="at">category =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-example-3" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="heatwaveR_workshop_2024_files/figure-html/fig-example-3-1.png" class="img-fluid figure-img" width="960"></p>
<figcaption class="figure-caption">Figure&nbsp;16: Default MCS category visual.</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="custom-mcs-category-visuals" class="level3">
<h3 class="anchored" data-anchor-id="custom-mcs-category-visuals">Custom MCS category visuals</h3>
<p>The following code chunk demonstrates how to manually create a figure showing the MCS categories.</p>
<div class="cell" data-layout-align="centre">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create category breaks and select slice of data.frame</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>MCS_clim_cat <span class="ot">&lt;-</span> MCS<span class="sc">$</span>clim <span class="sc">|&gt;</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">diff =</span> thresh <span class="sc">-</span> seas,</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>                <span class="at">thresh_2x =</span> thresh <span class="sc">+</span> diff,</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>                <span class="at">thresh_3x =</span> thresh_2x <span class="sc">+</span> diff,</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>                <span class="at">thresh_4x =</span> thresh_3x <span class="sc">+</span> diff) <span class="sc">|&gt;</span> </span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">slice</span>(<span class="dv">2910</span><span class="sc">:</span><span class="dv">3150</span>)</span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Set line colours</span></span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>lineColCat <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Temperature"</span> <span class="ot">=</span> <span class="st">"black"</span>,</span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Climatology"</span> <span class="ot">=</span> <span class="st">"grey40"</span>,</span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Threshold"</span> <span class="ot">=</span> <span class="st">"darkorchid"</span>,</span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a>  <span class="st">"2x Threshold"</span> <span class="ot">=</span> <span class="st">"darkorchid"</span>,</span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a>  <span class="st">"3x Threshold"</span> <span class="ot">=</span> <span class="st">"darkorchid"</span>,</span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a>  <span class="st">"4x Threshold"</span> <span class="ot">=</span> <span class="st">"darkorchid"</span></span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-19"><a href="#cb30-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Set category fill colours</span></span>
<span id="cb30-20"><a href="#cb30-20" aria-hidden="true" tabindex="-1"></a>fillColCat <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb30-21"><a href="#cb30-21" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Moderate"</span> <span class="ot">=</span> <span class="st">"#C7ECF2"</span>,</span>
<span id="cb30-22"><a href="#cb30-22" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Strong"</span> <span class="ot">=</span> <span class="st">"#85B7CC"</span>,</span>
<span id="cb30-23"><a href="#cb30-23" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Severe"</span> <span class="ot">=</span> <span class="st">"#4A6A94"</span>,</span>
<span id="cb30-24"><a href="#cb30-24" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Extreme"</span> <span class="ot">=</span> <span class="st">"#111433"</span></span>
<span id="cb30-25"><a href="#cb30-25" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb30-26"><a href="#cb30-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-27"><a href="#cb30-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Create plot</span></span>
<span id="cb30-28"><a href="#cb30-28" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> MCS_clim_cat, <span class="fu">aes</span>(<span class="at">x =</span> t, <span class="at">y =</span> temp)) <span class="sc">+</span></span>
<span id="cb30-29"><a href="#cb30-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_flame</span>(<span class="fu">aes</span>(<span class="at">y =</span> thresh, <span class="at">y2 =</span> temp, <span class="at">fill =</span> <span class="st">"Moderate"</span>)) <span class="sc">+</span></span>
<span id="cb30-30"><a href="#cb30-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_flame</span>(<span class="fu">aes</span>(<span class="at">y =</span> thresh_2x, <span class="at">y2 =</span> temp, <span class="at">fill =</span> <span class="st">"Strong"</span>)) <span class="sc">+</span></span>
<span id="cb30-31"><a href="#cb30-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_flame</span>(<span class="fu">aes</span>(<span class="at">y =</span> thresh_3x, <span class="at">y2 =</span> temp, <span class="at">fill =</span> <span class="st">"Severe"</span>)) <span class="sc">+</span></span>
<span id="cb30-32"><a href="#cb30-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_flame</span>(<span class="fu">aes</span>(<span class="at">y =</span> thresh_4x, <span class="at">y2 =</span> temp, <span class="at">fill =</span> <span class="st">"Extreme"</span>)) <span class="sc">+</span></span>
<span id="cb30-33"><a href="#cb30-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> thresh_2x, <span class="at">col =</span> <span class="st">"2x Threshold"</span>), <span class="at">size =</span> <span class="fl">0.7</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb30-34"><a href="#cb30-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> thresh_3x, <span class="at">col =</span> <span class="st">"3x Threshold"</span>), <span class="at">size =</span> <span class="fl">0.7</span>, <span class="at">linetype =</span> <span class="st">"dotdash"</span>) <span class="sc">+</span></span>
<span id="cb30-35"><a href="#cb30-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> thresh_4x, <span class="at">col =</span> <span class="st">"4x Threshold"</span>), <span class="at">size =</span> <span class="fl">0.7</span>, <span class="at">linetype =</span> <span class="st">"dotted"</span>) <span class="sc">+</span></span>
<span id="cb30-36"><a href="#cb30-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> seas, <span class="at">col =</span> <span class="st">"Climatology"</span>), <span class="at">size =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb30-37"><a href="#cb30-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> thresh, <span class="at">col =</span> <span class="st">"Threshold"</span>), <span class="at">size =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb30-38"><a href="#cb30-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> temp, <span class="at">col =</span> <span class="st">"Temperature"</span>), <span class="at">size =</span> <span class="fl">0.6</span>) <span class="sc">+</span></span>
<span id="cb30-39"><a href="#cb30-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_colour_manual</span>(<span class="at">name =</span> <span class="cn">NULL</span>, <span class="at">values =</span> lineColCat,</span>
<span id="cb30-40"><a href="#cb30-40" aria-hidden="true" tabindex="-1"></a>                      <span class="at">breaks =</span> <span class="fu">c</span>(<span class="st">"Temperature"</span>, <span class="st">"Climatology"</span>, <span class="st">"Threshold"</span>,</span>
<span id="cb30-41"><a href="#cb30-41" aria-hidden="true" tabindex="-1"></a>                                 <span class="st">"2x Threshold"</span>, <span class="st">"3x Threshold"</span>, <span class="st">"4x Threshold"</span>)) <span class="sc">+</span></span>
<span id="cb30-42"><a href="#cb30-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">name =</span> <span class="cn">NULL</span>, <span class="at">values =</span> fillColCat, <span class="at">guide =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb30-43"><a href="#cb30-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_date</span>(<span class="at">date_labels =</span> <span class="st">"%b %Y"</span>) <span class="sc">+</span></span>
<span id="cb30-44"><a href="#cb30-44" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">colour =</span> <span class="fu">guide_legend</span>(<span class="at">override.aes =</span> <span class="fu">list</span>(<span class="at">linetype =</span> <span class="fu">c</span>(<span class="st">"solid"</span>, <span class="st">"solid"</span>, <span class="st">"solid"</span>,</span>
<span id="cb30-45"><a href="#cb30-45" aria-hidden="true" tabindex="-1"></a>                                                                <span class="st">"dashed"</span>, <span class="st">"dotdash"</span>, <span class="st">"dotted"</span>),</span>
<span id="cb30-46"><a href="#cb30-46" aria-hidden="true" tabindex="-1"></a>                                                   <span class="at">size =</span> <span class="fu">c</span>(<span class="fl">0.6</span>, <span class="fl">0.7</span>, <span class="fl">0.7</span>, <span class="fl">0.7</span>, <span class="fl">0.7</span>, <span class="fl">0.7</span>)))) <span class="sc">+</span></span>
<span id="cb30-47"><a href="#cb30-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">y =</span> <span class="st">"Temperature [°C]"</span>, <span class="at">x =</span> <span class="cn">NULL</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-example-4" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="heatwaveR_workshop_2024_files/figure-html/fig-example-4-1.png" class="img-fluid figure-img" width="960"></p>
<figcaption class="figure-caption">Figure&nbsp;17: Custom MCS category visual.</figcaption>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="category-colour-palettes" class="level2">
<h2 class="anchored" data-anchor-id="category-colour-palettes">Category colour palettes</h2>
<p>For the sake of convenience the MHW and MCS colour palettes are provided below with a figure showing the direct comparison.</p>
<div class="cell" data-layout-align="centre">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co"># The MCS colour palette</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>MCS_colours <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Moderate"</span> <span class="ot">=</span> <span class="st">"#C7ECF2"</span>,</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Strong"</span> <span class="ot">=</span> <span class="st">"#85B7CC"</span>,</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Severe"</span> <span class="ot">=</span> <span class="st">"#4A6A94"</span>,</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Extreme"</span> <span class="ot">=</span> <span class="st">"#111433"</span></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a><span class="co"># The MHW colour palette</span></span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>MHW_colours <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Moderate"</span> <span class="ot">=</span> <span class="st">"#ffc866"</span>,</span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Strong"</span> <span class="ot">=</span> <span class="st">"#ff6900"</span>,</span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Severe"</span> <span class="ot">=</span> <span class="st">"#9e0000"</span>,</span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Extreme"</span> <span class="ot">=</span> <span class="st">"#2d0000"</span></span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the colour palette for plotting by itself</span></span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true" tabindex="-1"></a>colour_palette <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">category =</span> <span class="fu">factor</span>(<span class="fu">c</span>(<span class="st">"I Moderate"</span>, <span class="st">"II Strong"</span>, <span class="st">"III Severe"</span>, <span class="st">"IV Extreme"</span>),</span>
<span id="cb31-19"><a href="#cb31-19" aria-hidden="true" tabindex="-1"></a>                                               <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"I Moderate"</span>, <span class="st">"II Strong"</span>, <span class="st">"III Severe"</span>, <span class="st">"IV Extreme"</span>)),</span>
<span id="cb31-20"><a href="#cb31-20" aria-hidden="true" tabindex="-1"></a>                             <span class="at">MHW =</span> <span class="fu">c</span>(MHW_colours[<span class="dv">1</span>], MHW_colours[<span class="dv">2</span>], MHW_colours[<span class="dv">3</span>], MHW_colours[<span class="dv">4</span>]),</span>
<span id="cb31-21"><a href="#cb31-21" aria-hidden="true" tabindex="-1"></a>                             <span class="at">MCS =</span> <span class="fu">c</span>(MCS_colours[<span class="dv">1</span>], MCS_colours[<span class="dv">2</span>], MCS_colours[<span class="dv">3</span>], MCS_colours[<span class="dv">4</span>])) <span class="sc">|&gt;</span> </span>
<span id="cb31-22"><a href="#cb31-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">c</span>(MHW, MCS), <span class="at">names_to =</span> <span class="st">"event"</span>, <span class="at">values_to =</span> <span class="st">"colour"</span>)</span>
<span id="cb31-23"><a href="#cb31-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-24"><a href="#cb31-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Show the palettes side-by-side</span></span>
<span id="cb31-25"><a href="#cb31-25" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> colour_palette, <span class="fu">aes</span>(<span class="at">x =</span> category, <span class="at">y =</span> event)) <span class="sc">+</span></span>
<span id="cb31-26"><a href="#cb31-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_tile</span>(<span class="at">fill =</span> colour_palette<span class="sc">$</span>colour) <span class="sc">+</span></span>
<span id="cb31-27"><a href="#cb31-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">expand =</span> F) <span class="sc">+</span></span>
<span id="cb31-28"><a href="#cb31-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="cn">NULL</span>, <span class="at">y =</span> <span class="cn">NULL</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="heatwaveR_workshop_2024_files/figure-html/comp-fig-1.png" class="img-fluid figure-img" width="960"></p>
<figcaption class="figure-caption">MHW and MCS colour palettes for reference.</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="subset-data-download" class="level2">
<h2 class="anchored" data-anchor-id="subset-data-download">Subset data download</h2>
<p>For this training session we will see how to retrieve and prepare Reynolds optimally interpolated sea surface temperature (OISST) data for detecting marine heatwaves (MHWs). The OISST product is a global 1/4 degree gridded dataset of Advanced Very High Resolution Radiometer (AVHRR) derived SSTs at a daily resolution, starting on 1 September 1981. The source of the data is currently the <a href="https://www.ncei.noaa.gov/products/optimum-interpolation-sst">NOAA NCDC</a>.</p>
<p>We will be accessing and subsetting the NOAA OISST dataset on this <a href="https://coastwatch.pfeg.noaa.gov/erddap/griddap/index.html">ERDDAP server</a>. The global data are indexed <a href="https://www.ncei.noaa.gov/data/sea-surface-temperature-optimum-interpolation/v2.1/access/avhrr/">here</a>. One may download the data on both servers manually by using the ERDDAP UI or clicking on each indexed file individually. But programming languages like R are designed to prevent us from needing to experience that sort of anguish.</p>
<p>Each daily global file, when not compressed, is around 8.3 MB, so they add up to a large amount of data when a time series of the recommended 30 year minimum duration for the detection of MHWs is downloaded. If one were to download all of the data currently available it would exceed 100 GB of total disk space. It is therefore best practice to download only a subset of the data that matches one’s study area. Thanks to the <a href="https://docs.ropensci.org/rerddap/"><strong><code>rerddap</code></strong> package</a> this is incredibly easy to do in <code>R</code>.</p>
<p>Should one want to download the full global dataset, each daily global file is available in netCDF format and is roughly 1.6 MB. This means that one full year of global data will be roughly 600 MB, and the full dataset roughly 25 GB. This is however when the data are very compressed. If we were to attempt to load the entire uncompressed dataset into our memory at once it would take more than 200 GB of RAM. That is well beyond the scope of any laptop so in the second half of this vignette we will see how to download the full OISST dataset and then see how we can load only a subset of the data into the R environment for use with further analyses.</p>
<section id="file-information" class="level3">
<h3 class="anchored" data-anchor-id="file-information">File information</h3>
<p>Before we begin downloading the subsetted data for our study area we need to make sure that they are currently available on an ERDDAP server. The location of the NOAA OISST data has changed in the past so it should not be assumed that the current location will exist in perpetuity. Finding the server on which these data are located can be a cup game at times.</p>
<div class="cell" data-layout-align="centre">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co"># The information for the NOAA OISST data</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>rerddap<span class="sc">::</span><span class="fu">info</span>(<span class="at">datasetid =</span> <span class="st">"ncdcOisst21Agg_LonPM180"</span>, <span class="at">url =</span> <span class="st">"https://coastwatch.pfeg.noaa.gov/erddap/"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;ERDDAP info&gt; ncdcOisst21Agg_LonPM180 
 Base URL: https://coastwatch.pfeg.noaa.gov/erddap 
 Dataset Type: griddap 
 Dimensions (range):  
     time: (1981-09-01T12:00:00Z, 2024-05-02T12:00:00Z) 
     zlev: (0.0, 0.0) 
     latitude: (-89.875, 89.875) 
     longitude: (-179.875, 179.875) 
 Variables:  
     anom: 
         Units: degree_C 
     err: 
         Units: degree_C 
     ice: 
         Units: 1 
     sst: 
         Units: degree_C </code></pre>
</div>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Note that there is also a version with lon values from 0 to 360</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>rerddap<span class="sc">::</span><span class="fu">info</span>(<span class="at">datasetid =</span> <span class="st">"ncdcOisst21Agg"</span>, <span class="at">url =</span> <span class="st">"https://coastwatch.pfeg.noaa.gov/erddap/"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;ERDDAP info&gt; ncdcOisst21Agg 
 Base URL: https://coastwatch.pfeg.noaa.gov/erddap 
 Dataset Type: griddap 
 Dimensions (range):  
     time: (1981-09-01T12:00:00Z, 2024-05-02T12:00:00Z) 
     zlev: (0.0, 0.0) 
     latitude: (-89.875, 89.875) 
     longitude: (0.125, 359.875) 
 Variables:  
     anom: 
         Units: degree_C 
     err: 
         Units: degree_C 
     ice: 
         Units: 1 
     sst: 
         Units: degree_C </code></pre>
</div>
</div>
<p>With our target dataset identified we may now begin the download with the <code>rerddap::griddap()</code> function. Note that the ERDDAP server does not like it when one tries to access more than nine consecutive years of data in one request, regardless of the spatial extent being requested. So before we download our data we are going to make a wrapper function that helps us control the range of times we want to download. This will reduce the amount of redundant coding we would otherwise need to do.</p>
</section>
<section id="download-function" class="level3">
<h3 class="anchored" data-anchor-id="download-function">Download function</h3>
<div class="cell" data-layout-align="centre">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="co"># This function downloads and prepares data based on user provided start and end dates</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>OISST_sub_dl <span class="ot">&lt;-</span> <span class="cf">function</span>(time_df, lon_range, lat_range){</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>  OISST_dat <span class="ot">&lt;-</span> rerddap<span class="sc">::</span><span class="fu">griddap</span>(<span class="at">datasetx =</span> <span class="st">"ncdcOisst21Agg_LonPM180"</span>,</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>                                <span class="at">url =</span> <span class="st">"https://coastwatch.pfeg.noaa.gov/erddap/"</span>, </span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>                                <span class="at">time =</span> <span class="fu">c</span>(time_df<span class="sc">$</span>start, time_df<span class="sc">$</span>end), </span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>                                <span class="at">zlev =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>),</span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>                                <span class="at">latitude =</span> lat_range,</span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>                                <span class="at">longitude =</span> lon_range,</span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a>                                <span class="at">fields =</span> <span class="st">"sst"</span>)<span class="sc">$</span>data <span class="sc">|&gt;</span> </span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">time =</span> base<span class="sc">::</span><span class="fu">as.Date</span>(stringr<span class="sc">::</span><span class="fu">str_remove</span>(time, <span class="st">"T12:00:00Z"</span>))) <span class="sc">|&gt;</span> </span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">t =</span> time, <span class="at">temp =</span> sst, <span class="at">lon =</span> longitude, <span class="at">lat =</span> latitude) <span class="sc">|&gt;</span> </span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(lon, lat, t, temp) <span class="sc">|&gt;</span> </span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a>    stats<span class="sc">::</span><span class="fu">na.omit</span>()</span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<blockquote class="blockquote">
<blockquote class="blockquote">
<p>What is this function doing?</p>
</blockquote>
</blockquote>
<p>One must note here that depending on the RAM available on one’s machine, it may not be possible to handle all of the data downloaded at once if they are very large (e.g.&nbsp;&gt; 5 GB). The discussion on the limitations of the R language due to its dependence on virtual memory is beyond the scope of this training session, but if one limits one’s downloads to no more than several square pixels at a time that should be fine. Were one to try to download the whole Indian Ocean, for example, that may cause issues if being run on a laptop or computer of a similar power.</p>
</section>
<section id="date-range" class="level3">
<h3 class="anchored" data-anchor-id="date-range">Date range</h3>
<p>With our wrapper function written we would now need to run it several times in order to grab all of the OISST data from <code>1982-01-01</code> to <code>2023-12-31</code>. Even though each year of data for the extent used in this vignette is only ~360 KB, the server does not like it when more than 9 years of consecutive data are requested. The server will also end a users connection after ~17 individual files have been requested. Because we can’t download all of the data in one request, and we can’t download the data one year at a time, we will need to make requests for multiple batches of data. To accomplish this we will create a dataframe of start and end dates that will allow us to automate the entire download while meeting the aforementioned criteria.</p>
<div class="cell" data-layout-align="centre">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Date download range by start and end dates per year</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>dl_years <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">date_index =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>,</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>                       <span class="at">start =</span> <span class="fu">c</span>(<span class="st">"1982-01-01"</span>, <span class="st">"1990-01-01"</span>, </span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>                                 <span class="st">"1998-01-01"</span>, <span class="st">"2006-01-01"</span>, <span class="st">"2014-01-01"</span>),</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>                       <span class="at">end =</span> <span class="fu">c</span>(<span class="st">"1989-12-31"</span>, <span class="st">"1997-12-31"</span>, </span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>                               <span class="st">"2005-12-31"</span>, <span class="st">"2013-12-31"</span>, <span class="st">"2023-12-31"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="downloadprep-data" class="level3">
<h3 class="anchored" data-anchor-id="downloadprep-data">Download/prep data</h3>
<p>One could also use the <strong><code>plyr</code></strong> suite of functions to automate the process of downloading and processing multiple files, but I’ve chosen here to stick with the <strong><code>tidyverse</code></strong> native approach. If the below chunk of code fails or times out, simply re-run it until all of the data have been downloaded.</p>
<p>It is worth pointing out here that these data are downloaded as cached files on the users computer by using the <strong><code>hoardr</code></strong> package. This means that if one runs the same command again, it will not re-download the data because it first looks in the folder where it has automatically cached the data for you and sees that it may simply draw the data from there. No need to change anything or write a second script for loading data.</p>
<div class="cell" data-layout-align="centre">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Download all of the data with one nested request</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="co"># The time this takes will vary greatly based on connection speed</span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a><span class="co"># NB: Change the `lon_range` and `lat_range` values as desired</span></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a><span class="co"># But don't make them greater than a few degrees of longitude/latitude</span></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>base<span class="sc">::</span><span class="fu">system.time</span>(</span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>  OISST_data <span class="ot">&lt;-</span> dl_years <span class="sc">|&gt;</span> </span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">group_by</span>(date_index) <span class="sc">|&gt;</span> </span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">group_modify</span>(<span class="sc">~</span><span class="fu">OISST_sub_dl</span>(.x, <span class="at">lon_range =</span> <span class="fu">c</span>(<span class="dv">15</span>, <span class="dv">16</span>), </span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">lat_range =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">40</span>, <span class="sc">-</span><span class="dv">39</span>))) <span class="sc">|&gt;</span> </span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">|&gt;</span> </span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(lon, lat, t, temp)</span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a>) <span class="co"># ~2000 seconds, ~400 seconds per batch</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>If the above code chunk is giving errors it is likely due to one’s Internet connection timing out. There are also rare instances where the NOAA server is not responding due to an issue on their end. Most connection based issues may be resolved by simply waiting for a few minutes, or by ensuring a stable connection.</p>
</section>
<section id="visualise-data" class="level3">
<h3 class="anchored" data-anchor-id="visualise-data">Visualise data</h3>
<p>Before we save our data for later use it is good practice to visualise them.</p>
<div class="cell" data-layout-align="centre">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>OISST_data <span class="sc">|&gt;</span> </span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(t <span class="sc">==</span> <span class="st">"2023-12-01"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> lon, <span class="at">y =</span> lat)) <span class="sc">+</span></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_tile</span>(<span class="fu">aes</span>(<span class="at">fill =</span> temp)) <span class="sc">+</span></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># ggplot2::borders() + # Activate this line to see the global map</span></span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_fill_viridis_c</span>() <span class="sc">+</span></span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">coord_quickmap</span>(<span class="at">expand =</span> F) <span class="sc">+</span></span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">labs</span>(<span class="at">x =</span> <span class="cn">NULL</span>, <span class="at">y =</span> <span class="cn">NULL</span>, <span class="at">fill =</span> <span class="st">"SST [°C]"</span>) <span class="sc">+</span></span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="heatwaveR_workshop_2024_files/figure-html/sub-visual-1.png" class="img-fluid figure-img" width="960"></p>
<figcaption class="figure-caption">The downloaded grid of OISST data.</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="save-data" class="level3">
<h3 class="anchored" data-anchor-id="save-data">Save data</h3>
<p>With the data downloaded and prepared for further use (and a test visual run), let’s save them:</p>
<div class="cell" data-layout-align="centre">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Save the data as an .Rds file because it has a much better compression rate than .RData</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>base<span class="sc">::</span><span class="fu">saveRDS</span>(OISST_data, <span class="at">file =</span> <span class="st">"~/Desktop/OISST_data.Rds"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<blockquote class="blockquote">
<blockquote class="blockquote">
<p>Is the Desktop a reasonable place to save one’s data?</p>
</blockquote>
</blockquote>
</section>
</section>
<section id="global-data-download" class="level2">
<h2 class="anchored" data-anchor-id="global-data-download">Global data download</h2>
<p>If one needs to download the global dataset then it is preferable to go straight to the source. This makes dealing with individual files very easy, but agglomerating them into one file can be very time consuming.</p>
<section id="file-information-1" class="level3">
<h3 class="anchored" data-anchor-id="file-information-1">File information</h3>
<p>The first step in downloading the full global dataset is to tell you computer where they are. There is an automated way to do this but it requires a couple of additional packages and we aim to keep this vignette as simple and direct as possible. For our purposes today we will manually create the URLs of the files we want to download.</p>
<div class="cell" data-layout-align="centre">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="co"># First we tell R where the data are on the interwebs</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Note that one may go to this URL in any web browser to manually inspect the files</span></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>OISST_base_url <span class="ot">&lt;-</span> <span class="st">"https://www.ncei.noaa.gov/data/sea-surface-temperature-optimum-interpolation/v2.1/access/avhrr/"</span></span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Now we create a data.frame that contains all of the dates we want to download</span></span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a><span class="co"># NB: In order to change the dates download changes the dates in the following line</span></span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>OISST_dates <span class="ot">&lt;-</span> base<span class="sc">::</span><span class="fu">data.frame</span>(<span class="at">t =</span> <span class="fu">seq</span>(<span class="fu">as.Date</span>(<span class="st">"2019-12-01"</span>), <span class="fu">as.Date</span>(<span class="st">"2019-12-31"</span>), <span class="at">by =</span> <span class="st">"day"</span>))</span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a><span class="co"># To finish up this step we add some text to those dates so they match the OISST file names</span></span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a>OISST_files <span class="ot">&lt;-</span> OISST_dates <span class="sc">|&gt;</span> </span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">t_day =</span> base<span class="sc">::</span><span class="fu">gsub</span>(<span class="st">"-"</span>, <span class="st">""</span>, t),</span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a>                <span class="at">t_month =</span> base<span class="sc">::</span><span class="fu">substr</span>(t_day, <span class="dv">1</span>, <span class="dv">6</span>),</span>
<span id="cb41-13"><a href="#cb41-13" aria-hidden="true" tabindex="-1"></a>                <span class="at">t_year =</span> lubridate<span class="sc">::</span><span class="fu">year</span>(t),</span>
<span id="cb41-14"><a href="#cb41-14" aria-hidden="true" tabindex="-1"></a>                <span class="at">file_name =</span> base<span class="sc">::</span><span class="fu">paste0</span>(OISST_base_url, t_month, <span class="st">"/"</span>, <span class="st">"oisst-avhrr-v02r01."</span>, t_day ,<span class="st">".nc"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="download-data" class="level3">
<h3 class="anchored" data-anchor-id="download-data">Download data</h3>
<p>Now that we have a dataframe that contains all of the URLs for the files we want to download we’ll create a function that will crawl through those URLs and download the files for us.</p>
<div class="cell" data-layout-align="centre">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="co"># This function will go about downloading each day of data as a NetCDF file</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Note that this will download files into a 'data/OISST' folder in the root directory</span></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>OISST_url_daily_dl <span class="ot">&lt;-</span> <span class="cf">function</span>(target_URL){</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>  base<span class="sc">::</span><span class="fu">dir.create</span>(<span class="st">"~/data/OISST"</span>, <span class="at">showWarnings =</span> F)</span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>  file_name <span class="ot">&lt;-</span> base<span class="sc">::</span><span class="fu">paste0</span>(<span class="st">"~/data/OISST/"</span>,base<span class="sc">::</span><span class="fu">sapply</span>(base<span class="sc">::</span><span class="fu">strsplit</span>(target_URL, <span class="at">split =</span> <span class="st">"/"</span>), <span class="st">"[["</span>, <span class="dv">10</span>))</span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span>base<span class="sc">::</span><span class="fu">file.exists</span>(file_name)) utils<span class="sc">::</span><span class="fu">download.file</span>(<span class="at">url =</span> target_URL, <span class="at">method =</span> <span class="st">"libcurl"</span>, <span class="at">destfile =</span> file_name)</span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a><span class="co"># The more cores used, the faster the data may be downloaded</span></span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a><span class="co"># NB: It is best practice to not use all of the cores on one's machine</span></span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a><span class="co"># The laptop on which I am running this code has 8 cores, so I use 7 here</span></span>
<span id="cb42-12"><a href="#cb42-12" aria-hidden="true" tabindex="-1"></a>doParallel<span class="sc">::</span><span class="fu">registerDoParallel</span>(<span class="at">cores =</span> <span class="dv">7</span>)</span>
<span id="cb42-13"><a href="#cb42-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-14"><a href="#cb42-14" aria-hidden="true" tabindex="-1"></a><span class="co"># And with that we are clear for take off</span></span>
<span id="cb42-15"><a href="#cb42-15" aria-hidden="true" tabindex="-1"></a>base<span class="sc">::</span><span class="fu">system.time</span>(plyr<span class="sc">::</span><span class="fu">l_ply</span>(OISST_files<span class="sc">$</span>file_name, <span class="at">.fun =</span> OISST_url_daily_dl, <span class="at">.parallel =</span> T)) <span class="co"># ~15 seconds</span></span>
<span id="cb42-16"><a href="#cb42-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-17"><a href="#cb42-17" aria-hidden="true" tabindex="-1"></a><span class="co"># In roughly 15 seconds a user may have a full month of global data downloaded</span></span>
<span id="cb42-18"><a href="#cb42-18" aria-hidden="true" tabindex="-1"></a><span class="co"># This scales well into years and decades, and is much faster with more cores</span></span>
<span id="cb42-19"><a href="#cb42-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Download speeds will also depend on the speed of the users internet connection</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="load-data" class="level3">
<h3 class="anchored" data-anchor-id="load-data">Load data</h3>
<p>The following code chunk contains the function we may use to load and prepare our OISST data for further use in R.</p>
<div class="cell" data-layout-align="centre">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="co"># This function will load and subset daily data into one data.frame</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Note that the subsetting by lon/lat is done before the data are loaded</span></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># This means it will use much less RAM and is viable for use on most laptops</span></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Assuming one's study area is not too large</span></span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>OISST_load <span class="ot">&lt;-</span> <span class="cf">function</span>(file_name, lon1, lon2, lat1, lat2){</span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>      OISST_dat <span class="ot">&lt;-</span> tidync<span class="sc">::</span><span class="fu">tidync</span>(file_name) <span class="sc">|&gt;</span></span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>        tidync<span class="sc">::</span><span class="fu">hyper_filter</span>(<span class="at">lon =</span> dplyr<span class="sc">::</span><span class="fu">between</span>(lon, lon1, lon2),</span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>                             <span class="at">lat =</span> dplyr<span class="sc">::</span><span class="fu">between</span>(lat, lat1, lat2)) <span class="sc">|&gt;</span> </span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>        tidync<span class="sc">::</span><span class="fu">hyper_tibble</span>() <span class="sc">|&gt;</span> </span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">select</span>(lon, lat, time, sst) <span class="sc">|&gt;</span> </span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">t =</span> time, <span class="at">temp =</span> sst) <span class="sc">|&gt;</span> </span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">t =</span> <span class="fu">as.Date</span>(t, <span class="at">origin =</span> <span class="st">"1978-01-01"</span>))</span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(OISST_dat)</span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb43-15"><a href="#cb43-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-16"><a href="#cb43-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Locate the files that will be loaded</span></span>
<span id="cb43-17"><a href="#cb43-17" aria-hidden="true" tabindex="-1"></a>OISST_files <span class="ot">&lt;-</span> <span class="fu">dir</span>(<span class="st">"~/data/OISST"</span>, <span class="at">full.names =</span> T)</span>
<span id="cb43-18"><a href="#cb43-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-19"><a href="#cb43-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the data in parallel</span></span>
<span id="cb43-20"><a href="#cb43-20" aria-hidden="true" tabindex="-1"></a>OISST_dat <span class="ot">&lt;-</span> plyr<span class="sc">::</span><span class="fu">ldply</span>(<span class="at">.data =</span> OISST_files, <span class="at">.fun =</span> OISST_load, <span class="at">.parallel =</span> T,</span>
<span id="cb43-21"><a href="#cb43-21" aria-hidden="true" tabindex="-1"></a>                         <span class="at">lon1 =</span> <span class="dv">270</span>, <span class="at">lon2 =</span> <span class="dv">320</span>, <span class="at">lat1 =</span> <span class="dv">30</span>, <span class="at">lat2 =</span> <span class="dv">50</span>)</span>
<span id="cb43-22"><a href="#cb43-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-23"><a href="#cb43-23" aria-hidden="true" tabindex="-1"></a><span class="co"># It should only take a few seconds to load one month of data depending on the size of the lon/lat extent chosen</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="centre">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>OISST_load <span class="ot">&lt;-</span> <span class="cf">function</span>(file_name, lon1, lon2, lat1, lat2){</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>      OISST_dat <span class="ot">&lt;-</span> tidync<span class="sc">::</span><span class="fu">tidync</span>(file_name) <span class="sc">|&gt;</span></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>        tidync<span class="sc">::</span><span class="fu">hyper_filter</span>(<span class="at">lon =</span> dplyr<span class="sc">::</span><span class="fu">between</span>(lon, lon1, lon2),</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>                             <span class="at">lat =</span> dplyr<span class="sc">::</span><span class="fu">between</span>(lat, lat1, lat2)) <span class="sc">|&gt;</span> </span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>        tidync<span class="sc">::</span><span class="fu">hyper_tibble</span>() <span class="sc">|&gt;</span> </span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">select</span>(lon, lat, time, sst) <span class="sc">|&gt;</span> </span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">t =</span> time, <span class="at">temp =</span> sst) <span class="sc">|&gt;</span> </span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">t =</span> <span class="fu">as.Date</span>(t, <span class="at">origin =</span> <span class="st">"1978-01-01"</span>))</span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(OISST_dat)</span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a>doParallel<span class="sc">::</span><span class="fu">registerDoParallel</span>(<span class="at">cores =</span> <span class="dv">7</span>)</span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a>OISST_files <span class="ot">&lt;-</span> <span class="fu">dir</span>(<span class="st">"~/data/OISST"</span>, <span class="at">full.names =</span> T)[<span class="dv">13849</span><span class="sc">:</span><span class="dv">13879</span>]</span>
<span id="cb44-13"><a href="#cb44-13" aria-hidden="true" tabindex="-1"></a>OISST_dat <span class="ot">&lt;-</span> plyr<span class="sc">::</span><span class="fu">ldply</span>(<span class="at">.data =</span> OISST_files, <span class="at">.fun =</span> OISST_load, <span class="at">.parallel =</span> T,</span>
<span id="cb44-14"><a href="#cb44-14" aria-hidden="true" tabindex="-1"></a>                         <span class="at">lon1 =</span> <span class="dv">270</span>, <span class="at">lon2 =</span> <span class="dv">320</span>, <span class="at">lat1 =</span> <span class="dv">30</span>, <span class="at">lat2 =</span> <span class="dv">50</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>In the code chunk above I have chosen the spatial extent of longitude 270 to 320 and latitude 30 to 50. This a window over the Atlantic Coast of North America. One may simply change the lon/lat values above as necessary to match the desired study area. The function also re-labels the ‘time’ column as ‘t’, and the ‘sst’ column as ‘temp’. We do this now so that they match the default column names that are expected for calculating MHWs so we won’t have to do any extra work later on.</p>
<p>Again, please note that trying to load too much data at once may be too much for the RAM on one’s machine. If running the above code causes one’s machine to hang, try loading a smaller subset of data. Or make friends with someone with a server sized machine.</p>
</section>
<section id="visualise-data-1" class="level3">
<h3 class="anchored" data-anchor-id="visualise-data-1">Visualise data</h3>
<p>It is always good to visualise data early and often in any workflow. The code pipeline below shows how we can visualise a day of data from those we’ve loaded.</p>
<div class="cell" data-layout-align="centre">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>OISST_dat <span class="sc">|&gt;</span> </span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(t <span class="sc">==</span> <span class="st">"2019-12-01"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> lon, <span class="at">y =</span> lat)) <span class="sc">+</span></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_tile</span>(<span class="fu">aes</span>(<span class="at">fill =</span> temp)) <span class="sc">+</span></span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_fill_viridis_c</span>() <span class="sc">+</span></span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">coord_quickmap</span>(<span class="at">expand =</span> F) <span class="sc">+</span></span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">labs</span>(<span class="at">x =</span> <span class="cn">NULL</span>, <span class="at">y =</span> <span class="cn">NULL</span>, <span class="at">fill =</span> <span class="st">"SST (°C)"</span>) <span class="sc">+</span></span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="heatwaveR_workshop_2024_files/figure-html/NOAA-visual-1.png" class="img-fluid figure-img" width="960"></p>
<figcaption class="figure-caption">A day in the life of the Gulf Stream.</figcaption>
</figure>
</div>
</div>
</div>
<blockquote class="blockquote">
<blockquote class="blockquote">
<p>How could we rather visualise SSTa?</p>
</blockquote>
</blockquote>
</section>
</section>
<section id="gridded-event-detection" class="level2">
<h2 class="anchored" data-anchor-id="gridded-event-detection">Gridded event detection</h2>
<section id="two-good-choices-dplyr-vs.-plyr" class="level3">
<h3 class="anchored" data-anchor-id="two-good-choices-dplyr-vs.-plyr">Two good choices: <strong><code>dplyr</code></strong> vs.&nbsp;<strong><code>plyr</code></strong></h3>
<p>When we want to make the same calculation across multiple groups of data within one dataframe we have two good options available to us. The first is to make use of the <code>map()</code> suite of functions found in the <strong><code>purrr</code></strong> package, and now implemented in <strong><code>dplyr</code></strong>. This is a very fast <strong><code>tidyverse</code></strong> friendly approach to splitting up tasks. The other good option is to go back in time a bit and use the <code>ddply()</code> function from the <strong><code>plyr</code></strong> package. This is arguably a better approach as it allows us to very easily use multiple cores to detect the MHWs. The problem with this approach is that one must <em>never</em> load the <strong><code>plyr</code></strong> library directly as it has some fundamental inconsistencies with the <strong><code>tidyverse</code></strong>. We will see below how to perform these two different techniques without causing ourselves any headaches.</p>
<p>It is a little clumsy to use multiple functions at once with the two methods so we will combine the calculations we want to make into one wrapper function.</p>
<div class="cell" data-layout-align="centre">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>event_only <span class="ot">&lt;-</span> <span class="cf">function</span>(df){</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># First calculate the climatologies</span></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>  clim <span class="ot">&lt;-</span> <span class="fu">ts2clm</span>(<span class="at">data =</span> df, <span class="at">climatologyPeriod =</span> <span class="fu">c</span>(<span class="st">"1982-01-01"</span>, <span class="st">"2011-01-01"</span>))</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Then the events</span></span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>  event <span class="ot">&lt;-</span> <span class="fu">detect_event</span>(<span class="at">data =</span> clim)</span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Return only the event metric dataframe of results</span></span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(event<span class="sc">$</span>event)</span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="the-dplyr-method" class="level4">
<h4 class="anchored" data-anchor-id="the-dplyr-method">The <strong><code>dplyr</code></strong> method</h4>
<p>This method requires no special consideration and is performed just as any other friendly <strong><code>tidyverse</code></strong> code chunk would be.</p>
<div class="cell" data-layout-align="centre">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>(</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a><span class="co"># First we start by choosing the 'OISST' dataframe</span></span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>MHW_dplyr <span class="ot">&lt;-</span> OISST_data <span class="sc">|&gt;</span> </span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Then we group the data by the 'lon' and 'lat' columns</span></span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(lon, lat) <span class="sc">|&gt;</span> </span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Then we run our MHW detecting function on each group</span></span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_modify</span>(<span class="sc">~</span><span class="fu">event_only</span>(.x))</span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a>) <span class="co"># ~7 seconds</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   user  system elapsed 
 12.934   0.055   7.760 </code></pre>
</div>
</div>
<p>Running the above calculations with only one of the 2.8 GHz cores on a modern laptop took ~7 seconds. It must be noted however that a recent update to the <strong><code>dplyr</code></strong> package now allows it to interrogate one’s computer to determine how many cores it has at it’s disposal. It then uses one core at full capacity and the other cores usually at half capacity.</p>
</section>
<section id="the-plyr-technique" class="level4">
<h4 class="anchored" data-anchor-id="the-plyr-technique">The <strong><code>plyr</code></strong> technique</h4>
<p>This method requires that we first tell our machine how many of its processor cores to give us for our calculation.</p>
<div class="cell" data-layout-align="centre">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="co"># NB: One should never use ALL available cores, save at least 1 for other essential tasks</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a><span class="co"># The computer I'm writing this vignette on has 8 cores, so I use 7 here</span></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a><span class="fu">detectCores</span>(); <span class="fu">registerDoParallel</span>(<span class="at">cores =</span> <span class="dv">7</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 8</code></pre>
</div>
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Detect events</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>(</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>MHW_plyr <span class="ot">&lt;-</span> plyr<span class="sc">::</span><span class="fu">ddply</span>(<span class="at">.data =</span> OISST_data, <span class="at">.variables =</span> <span class="fu">c</span>(<span class="st">"lon"</span>, <span class="st">"lat"</span>), <span class="at">.fun =</span> event_only, <span class="at">.parallel =</span> <span class="cn">TRUE</span>)</span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>) <span class="co"># 3 seconds</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   user  system elapsed 
 11.745   1.353   2.171 </code></pre>
</div>
</div>
<p>The <strong><code>plyr</code></strong> technique took 3 seconds using seven cores. This technique is not seven times faster because when using multiple cores there is a certain amount of loss in efficiency due to the computer needing to remember which results are meant to go where so that it can stitch everything back together again for you. This takes very little memory, but over large jobs it can start to become problematic. Occasionally ‘slippage’ can occur as well where an entire task can be forgotten. This is very rare but does happen. This is partly what makes <strong><code>dplyr</code></strong> a viable option as it does not have this problem. The other reason is that <strong><code>dplyr</code></strong> performs more efficient calculations than <strong><code>plyr</code></strong>. I’ll leave it to the curious investigator to decide for themselves which method to use.</p>
</section>
</section>
</section>
<section id="references" class="level2">
<h2 class="anchored" data-anchor-id="references">References</h2>
<p>Hobday, A.J. et al.&nbsp;(2016). A hierarchical approach to defining marine heatwaves. Progress in Oceanography, 141, pp.&nbsp;227-238.</p>
<p>Hobday, A. J., Oliver, E. C. J., Sen Gupta, A., Benthuysen, J. A., Burrows, M. T., Donat, M. G., Holbrook, N. J., Moore, P. J., Thomsen, M. S., Wernberg, T., Smale, D. A. (2018). Categorizing and naming marine heatwaves. Oceanography 31(2).</p>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>